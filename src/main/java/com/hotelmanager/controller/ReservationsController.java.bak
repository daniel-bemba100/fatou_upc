package com.hotelmanager.controller;

import com.hotelmanager.Main;
import com.hotelmanager.dao.ReservationDAO;
import com.hotelmanager.model.Reservation;
import com.hotelmanager.model.ReservationStatus;
import com.hotelmanager.util.Logger;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import java.io.IOException;
import java.time.LocalDate;
import java.util.List;

public class ReservationsController {
    
    @FXML
    private TextField customerIdField;
    
    @FXML
    private TextField roomIdField;
    
    @FXML
    private DatePicker checkInPicker;
    
    @FXML
    private DatePicker checkOutPicker;
    
    @FXML
    private TextField guestsField;
    
    @FXML
    private TextField amountField;
    
    @FXML
    private TableView<Reservation> reservationsTable;
    
    private ReservationDAO reservationDAO;
    private ObservableList<Reservation> reservationList;
    
    public ReservationsController() {
        this.reservationDAO = new ReservationDAO();
        this.reservationList = FXCollections.observableArrayList();
    }
    
    @FXML
    public void initialize() {
        setupTableColumns();
        loadReservations();
    }
    
    private void setupTableColumns() {
        reservationsTable.getColumns().clear();
        reservationsTable.getColumns().addAll(
            createColumn("ID", "id", 50),
            createColumn("Customer ID", "customerId", 80),
            createColumn("Room ID", "roomId", 60),
            createColumn("Check-In", "checkInDate", 100),
            createColumn("Check-Out", "checkOutDate", 100),
            createColumn("Guests", "numberOfGuests", 60),
            createColumn("Amount", "totalAmount", 80),
            createColumn("Status", "statusCode", 100)
        );
    }
    
    private TableColumn<Reservation, ?> createColumn(String title, String property, int width) {
        TableColumn<Reservation, ?> col = new TableColumn<>(title);
        col.setCellValueFactory(new PropertyValueFactory<>(property));
        col.setPrefWidth(width);
        return col;
    }
    
    private void loadReservations() {
        try {
            List<Reservation> reservations = reservationDAO.findAll();
            reservationList.setAll(reservations);
            reservationsTable.setItems(reservationList);
        } catch (Exception e) {
            Logger.error("Error loading reservations", e);
            showAlert("Error", "Failed to load reservations: " + e.getMessage());
        }
    }
    
    @FXML
    private void createReservation() {
        String customerIdStr = customerIdField.getText().trim();
        String roomIdStr = roomIdField.getText().trim();
        String guestsStr = guestsField.getText().trim();
        String amountStr = amountField.getText().trim();
        
        if (customerIdStr.isEmpty() || roomIdStr.isEmpty() || 
            checkInPicker.getValue() == null || checkOutPicker.getValue() == null) {
            showAlert("Validation Error", "Please fill in all required fields");
            return;
        }
        
        try {
            int customerId = Integer.parseInt(customerIdStr);
            int roomId = Integer.parseInt(roomIdStr);
            int guests = Integer.parseInt(guestsStr.isEmpty() ? "1" : guestsStr);
            double amount = Double.parseDouble(amountStr.isEmpty() ? "0" : amountStr);
            LocalDate checkIn = checkInPicker.getValue();
            LocalDate checkOut = checkOutPicker.getValue();
            
            if (checkOut.isBefore(checkIn) || checkIn.isBefore(LocalDate.now())) {
                showAlert("Validation Error", "Invalid dates");
                return;
            }
            
            Reservation reservation = new Reservation();
            reservation.setCustomerId(customerId);
            reservation.setRoomId(roomId);
            reservation.setUserId(LoginController.getCurrentUser().getId());
            reservation.setCheckInDate(checkIn);
            reservation.setCheckOutDate(checkOut);
            reservation.setNumberOfGuests(guests);
            reservation.setTotalAmount(amount);
            reservation.setStatusCode(ReservationStatus.PENDING.getCode());
            
            reservationDAO.insert(reservation);
            Logger.info("Reservation created for customer: " + customerId);
            
            clearForm();
            loadReservations();
            showAlert("Success", "Reservation created successfully");
        } catch (Exception e) {
            Logger.error("Error creating reservation", e);
            showAlert("Error", "Failed to create reservation: " + e.getMessage());
        }
    }
    
    private void clearForm() {
        customerIdField.clear();
        roomIdField.clear();
        checkInPicker.setValue(null);
        checkOutPicker.setValue(null);
        guestsField.clear();
        amountField.clear();
    }
    
    @FXML
    private void goToDashboard() throws IOException {
        Main.switchScene("dashboard", 1200, 800, "Hotel Manager Pro - Dashboard", true);
    }
    
    private void showAlert(String title, String message) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }
}
