package com.hotelmanager.controller;

import java.io.IOException;
import java.sql.SQLException;
import java.time.Year;

import com.hotelmanager.Main;
import com.hotelmanager.dao.UserDAO;
import com.hotelmanager.model.User;
import com.hotelmanager.model.UserRole;
import com.hotelmanager.util.Logger;
import com.hotelmanager.util.PasswordUtil;

import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.control.Label;
import javafx.scene.control.PasswordField;
import javafx.scene.control.TextField;
import javafx.scene.layout.StackPane;
import javafx.scene.paint.Color;

public class AdminRegistrationController {
    
    @FXML
    private TextField usernameField;
    
    @FXML
    private PasswordField passwordField;
    
    @FXML
    private PasswordField confirmPasswordField;
    
    @FXML
    private TextField emailField;
    
    @FXML
    private TextField firstNameField;
    
    @FXML
    private TextField lastNameField;
    
    @FXML
    private TextField phoneField;
    
    @FXML
    private Label errorLabel;
    
    @FXML
    private Label footerLabel;
    
    private UserDAO userDAO;
    
    public AdminRegistrationController() {
        this.userDAO = new UserDAO();
    }
    
    @FXML
    private void initialize() {
        // Set dynamic copyright year
        int currentYear = Year.now().getValue();
        footerLabel.setText("Â© " + currentYear + " Hotel Manager Pro");
    }
    
    @FXML
    private void handleRegister() {
        // Get values
        String username = usernameField.getText().trim();
        String password = passwordField.getText();
        String confirmPassword = confirmPasswordField.getText();
        String email = emailField.getText().trim();
        String firstName = firstNameField.getText().trim();
        String lastName = lastNameField.getText().trim();
        String phone = phoneField.getText().trim();
        
        // Validate input
        if (!validateInput(username, password, confirmPassword, email, firstName, lastName)) {
            return;
        }
        
        try {
            // Check if username already exists
            User existingUser = userDAO.findByUsername(username);
            if (existingUser != null) {
                showError("Username already exists. Please choose a different username.");
                return;
            }
            
            // Create new admin user
            User newUser = new User();
            newUser.setUsername(username);
            newUser.setPasswordHash(PasswordUtil.hashPassword(password));
            newUser.setEmail(email.isEmpty() ? null : email);
            newUser.setFirstName(firstName.isEmpty() ? null : firstName);
            newUser.setLastName(lastName.isEmpty() ? null : lastName);
            newUser.setPhone(phone.isEmpty() ? null : phone);
            newUser.setRole(UserRole.ADMIN);
            newUser.setActive(true);
            
            // Save to database
            int userId = userDAO.insert(newUser);
            
            if (userId > 0) {
                Logger.info("Admin user registered successfully: " + username);
                showSuccessMessage("Admin account created successfully! You can now log in.");
                
                // Redirect to login after short delay
                Thread.sleep(1500);
                navigateToLogin();
            } else {
                showError("Failed to create admin account. Please try again.");
            }
            
        } catch (SQLException e) {
            Logger.error("Database error during registration", e);
            showError("Database error: " + e.getMessage());
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } catch (Exception e) {
            Logger.error("Error during registration", e);
            showError("Registration failed: " + e.getMessage());
        }
    }
    
    private boolean validateInput(String username, String password, String confirmPassword, 
                                  String email, String firstName, String lastName) {
        
        // Check required fields
        if (username.isEmpty()) {
            showError("Username is required");
            return false;
        }
        
        if (password.isEmpty()) {
            showError("Password is required");
            return false;
        }
        
        if (password.length() < 6) {
            showError("Password must be at least 6 characters");
            return false;
        }
        
        if (!password.equals(confirmPassword)) {
            showError("Passwords do not match");
            return false;
        }
        
        // Validate username format
        if (!username.matches("^[a-zA-Z0-9_]+$")) {
            showError("Username can only contain letters, numbers, and underscores");
            return false;
        }
        
        // Validate email format if provided
        if (!email.isEmpty() && !email.matches("^[A-Za-z0-9+_.-]+@(.+)$")) {
            showError("Invalid email format");
            return false;
        }
        
        hideError();
        return true;
    }
    
    private void showError(String message) {
        errorLabel.setText(message);
        errorLabel.setTextFill(Color.RED);
        errorLabel.setVisible(true);
        errorLabel.setManaged(true);
    }
    
    private void hideError() {
        errorLabel.setVisible(false);
        errorLabel.setManaged(false);
    }
    
    private void showSuccessMessage(String message) {
        errorLabel.setText(message);
        errorLabel.setTextFill(Color.GREEN);
        errorLabel.setVisible(true);
        errorLabel.setManaged(true);
    }
    
    /**
     * Navigate to login screen (called from FXML link)
     */
    @FXML
    public void navigateToLogin() {
        try {
            FXMLLoader loader = new FXMLLoader(Main.class.getResource("/fxml/login.fxml"));
            Parent loginRoot = loader.load();
            
            // Get the current scene root (StackPane)
            StackPane root = (StackPane) usernameField.getScene().getRoot();
            root.getChildren().clear();
            root.getChildren().add(loginRoot);
            
        } catch (IOException e) {
            Logger.error("Error navigating to login", e);
        }
    }
}

